# Data Model: Integrated RAG AI Chatbot

## Entity: Query
**Description**: Represents a user's question submitted to the system
- **query_id**: UUID (Primary Key) - Unique identifier for the query
- **user_id**: UUID - Identifier for the user (optional for anonymous users)
- **question_text**: String (255 chars max) - The text of the user's question
- **query_mode**: Enum ['global', 'selected_text'] - The mode of the query
- **selected_text**: String (Text, optional) - The text selected by the user (for selected_text mode)
- **timestamp**: DateTime - When the query was submitted
- **session_id**: UUID - Reference to the user session

## Entity: Context Chunk
**Description**: A segment of book content retrieved from vector storage that is relevant to a query
- **chunk_id**: UUID (Primary Key) - Unique identifier for the chunk
- **content**: Text - The actual content of the chunk
- **source_document**: String (255 chars max) - Path to the source document in the book
- **source_section**: String (255 chars max) - Section title where the chunk originated
- **embedding_vector**: Binary - The vector representation of the content (stored in Qdrant)
- **metadata**: JSON - Additional metadata about the chunk (page number, chapter, etc.)
- **created_at**: DateTime - When the chunk was created/processed

## Entity: User Session
**Description**: The interaction state between a user and the chatbot during a session
- **session_id**: UUID (Primary Key) - Unique identifier for the session
- **user_id**: UUID - Identifier for the user (optional for anonymous users)
- **start_time**: DateTime - When the session started
- **last_interaction**: DateTime - When the last interaction occurred
- **active**: Boolean - Whether the session is currently active
- **metadata**: JSON - Additional session metadata (preferences, context, etc.)

## Entity: Embedding
**Description**: Vector representation of book content used for semantic search and retrieval
- **embedding_id**: UUID (Primary Key) - Unique identifier for the embedding
- **chunk_id**: UUID (Foreign Key) - Reference to the associated content chunk
- **vector_data**: Binary - The actual embedding vector
- **model_used**: String (100 chars max) - The model used to generate the embedding
- **created_at**: DateTime - When the embedding was generated

## Entity: Book Content
**Description**: The Docusaurus markdown content that has been processed and stored for RAG
- **content_id**: UUID (Primary Key) - Unique identifier for the content
- **document_path**: String (500 chars max) - Path to the document in the Docusaurus structure
- **title**: String (255 chars max) - Title of the document
- **content_text**: Text - The raw text content of the document
- **processed**: Boolean - Whether the content has been processed for RAG
- **last_modified**: DateTime - When the content was last updated
- **metadata**: JSON - Additional metadata from the Docusaurus document (frontmatter, etc.)

## Entity: Chat Log
**Description**: Log of user interactions for analytics and improvement purposes
- **log_id**: UUID (Primary Key) - Unique identifier for the log entry
- **query_id**: UUID (Foreign Key) - Reference to the associated query
- **response_text**: Text - The response generated by the chatbot
- **relevance_score**: Float (0.0-1.0) - How relevant the response was (if rated by user)
- **user_feedback**: Text (optional) - User feedback about the response
- **timestamp**: DateTime - When the interaction occurred
- **response_time_ms**: Integer - Time taken to generate the response

## Relationships
- User Session (1) ←→ (Many) Query: A session can have multiple queries
- Query (1) ←→ (Many) Context Chunk: A query can retrieve multiple context chunks
- Context Chunk (1) ←→ (1) Embedding: Each chunk has one corresponding embedding
- Book Content (1) ←→ (Many) Context Chunk: One book content can be chunked into multiple context chunks
- Query (1) ←→ (1) Chat Log: Each query generates one log entry

## Validation Rules
- Query: question_text must not be empty, query_mode must be one of the allowed values
- Context Chunk: content must not be empty, source_document must exist in Book Content
- User Session: session_id must be unique
- Embedding: chunk_id must reference an existing Context Chunk
- Chat Log: query_id must reference an existing Query

## State Transitions
- User Session: inactive → active → inactive (based on user interactions and timeout)